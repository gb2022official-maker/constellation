<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Constellation Grid: Star + 10×10 + Drag/Drop + Snapshot + JSON</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0C1224;
      --panel: rgba(15,26,51,.72);
      --ink:#EAF0FF;
      --muted:#B9C2E3;
      --line: rgba(255,255,255,.12);

      --a:#7CFFCB;
      --b:#8AB4FF;
      --c:#FF6AD5;
      --d:#FFD36A;
      --e:#B388FF;

      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;

      --cell: 68px;
      --gap: 10px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,255,203,.15), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(138,180,255,.18), transparent 55%),
        radial-gradient(900px 700px at 45% 100%, rgba(255,106,213,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 18px 10px;
      display:flex; gap:12px; align-items:flex-start;
    }
    .sigil{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 220deg, var(--a), var(--b), var(--c), var(--d), var(--e), var(--a));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .sigil:before{
      content:"";
      position:absolute; inset:2px;
      border-radius:12px;
      background: radial-gradient(16px 16px at 30% 25%, rgba(255,255,255,.55), transparent 60%),
                  radial-gradient(22px 22px at 70% 70%, rgba(0,0,0,.35), transparent 60%),
                  rgba(10,16,34,.65);
      border: 1px solid rgba(255,255,255,.14);
    }
    h1{ margin:0; font-size: clamp(1.15rem, 2.2vw, 1.65rem); letter-spacing:.2px; }
    .sub{ margin:7px 0 0; color:var(--muted); line-height:1.45; max-width: 92ch; font-size: .96rem; }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px 40px;
    }

    .card{
      background: linear-gradient(180deg, rgba(15,26,51,.82), rgba(15,26,51,.55));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(90deg, rgba(124,255,203,.08), rgba(138,180,255,.06), rgba(255,106,213,.06));
      flex-wrap:wrap;
    }
    .bd{ padding: 14px; }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }

    /* Stack: Star -> Grid -> Tray -> Controls */
    .centerStack{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
    }

    .starPreview{
      width: min(100%, calc((var(--cell) * 10) + (var(--gap) * 9) + 24px));
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(260px 130px at 25% 20%, rgba(255,211,106,.12), transparent 65%),
        radial-gradient(320px 150px at 80% 55%, rgba(179,136,255,.12), transparent 65%),
        rgba(0,0,0,.18);
      position:relative;
      min-height: 340px;
      display:flex; align-items:center; justify-content:center;
      padding: 14px;
      overflow:hidden;
    }
    .starPreview img{
      max-width:100%;
      max-height: 520px;
      object-fit:contain;
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .placeholder{
      text-align:center;
      color: var(--muted);
      line-height:1.4;
      max-width: 60ch;
    }
    .sparkline{
      position:absolute; inset:auto 12px 12px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      font-size:.78rem;
      color: rgba(234,240,255,.82);
    }
    .sparkbar{
      flex:1;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .sparkbar > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(90deg, rgba(124,255,203,.16), rgba(138,180,255,.14), rgba(255,106,213,.14));
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 750;
      letter-spacing:.2px;
    }
    button.secondary{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-weight: 650;
    }
    button:active{ transform: translateY(1px); }

    /* Grid */
    .gridBlock{
      width: min(100%, calc((var(--cell) * 10) + (var(--gap) * 9) + 24px));
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      padding: 12px;
    }
    .gridMetaLine{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .metaText{
      color: var(--muted);
      font-size: .9rem;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(10, var(--cell));
      gap: var(--gap);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 20% 0%, rgba(124,255,203,.10), transparent 60%),
        radial-gradient(620px 360px at 90% 30%, rgba(255,106,213,.09), transparent 60%),
        rgba(0,0,0,.16);
      overflow:auto;
      max-width: 100%;
    }
    .cell{
      width: var(--cell);
      height: var(--cell);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      user-select:none;
    }
    .cell:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .cell.dragOver{
      outline: 2px solid rgba(124,255,203,.65);
      outline-offset: 2px;
      border-color: rgba(124,255,203,.55);
    }
    .cell img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.03) contrast(1.03);
    }
    .cell .idx{
      position:absolute;
      right:6px; bottom:6px;
      font-size: .70rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,.50);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(234,240,255,.92);
      pointer-events:none;
    }

    /* Tray */
    .tray{
      width: min(100%, calc((var(--cell) * 10) + (var(--gap) * 9) + 24px));
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      padding: 12px;
    }
    .trayTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
      gap: 10px;
    }
    .thumb{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
      cursor: grab;
      user-select:none;
      aspect-ratio: 1 / 1;
    }
    .thumb:active{ cursor: grabbing; }
    .thumb img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .thumb .name{
      position:absolute;
      left:6px; right:6px; bottom:6px;
      font-size: .70rem;
      padding: 3px 6px;
      border-radius: 10px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(234,240,255,.9);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      pointer-events:none;
    }

    /* Controls bottom */
    .controls{
      width: min(100%, calc((var(--cell) * 10) + (var(--gap) * 9) + 24px));
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
      margin-top: 2px;
    }
    @media (max-width: 860px){
      .controls{ grid-template-columns: 1fr; }
    }
    .controls .box{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      padding: 12px;
    }
    .controls label{
      display:block;
      color: var(--muted);
      font-size: .85rem;
      margin: 10px 0 6px;
    }
    input[type="text"], textarea, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input[type="file"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }

    /* Modal */
    dialog{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(10,16,34,.96);
      color: var(--ink);
      box-shadow: var(--shadow);
      width: min(760px, calc(100% - 24px));
    }
    dialog::backdrop{
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .dlgHd{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(255,211,106,.08), rgba(179,136,255,.08), rgba(138,180,255,.06));
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }
    .dlgHd b{ letter-spacing:.2px; }
    .dlgBd{ padding: 12px; }
    .dlgGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .dlgGrid{ grid-template-columns: 1fr; }
    }
    .previewBox{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      min-height: 240px;
      display:flex; align-items:center; justify-content:center;
      padding: 12px;
      overflow:hidden;
    }
    .previewBox img{
      max-width:100%;
      max-height: 420px;
      object-fit:contain;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .tiny{
      color: rgba(234,240,255,.72);
      font-size: .82rem;
      line-height:1.35;
    }
    .notice{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,240,255,.78);
      font-size: .86rem;
      line-height:1.35;
    }
    .notice b{ color: var(--d); }
  </style>
</head>

<body>
<header>
  <div class="sigil" aria-hidden="true"></div>
  <div>
    <h1>Constellation Grid</h1>
    <p class="sub">
      Upload a bunch of images. Drag them into the grid. Metadata follows the image (not the cell).
      Export JSON for plug-and-play recreation, and download a snapshot PNG of the Star + Grid.
    </p>
  </div>
</header>

<main>
  <section class="card" aria-label="Star and grid">
    <div class="hd">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span class="pill">⭐ Star + 10×10</span>
        <span class="pill" style="border-color:rgba(124,255,203,.28)">Drag & Drop</span>
        <span class="pill" style="border-color:rgba(255,106,213,.26)">Snapshot + JSON</span>
      </div>
      <span class="pill" id="filledPill">0 / 100 filled</span>
    </div>

    <div class="bd">
      <div class="centerStack" id="captureRoot">
        <!-- STAR -->
        <div class="starPreview" id="starPreview" aria-label="Star preview">
          <div class="placeholder" id="starPlaceholder">
            <div style="font-weight:900;font-size:1.05rem;margin-bottom:6px">Drop a Star image here</div>
            <div>Drag from the tray below, or upload a file/URL in the controls.</div>
          </div>
          <img id="starImg" alt="" style="display:none" />
          <div class="sparkline">
            <span>Grid Resonance</span>
            <div class="sparkbar" aria-hidden="true"><i id="resFill"></i></div>
            <span id="resPct">0%</span>
          </div>
        </div>

        <!-- GRID -->
        <div class="gridBlock" aria-label="Grid block">
          <div class="gridMetaLine">
            <div class="metaText">Drag from tray → drop into a cell. Click a placed image (or tray thumb) to edit metadata.</div>
            <div class="metaText" id="metaLine">Selected: none</div>
          </div>
          <div class="grid" id="grid" aria-label="10 by 10 grid"></div>
        </div>

        <!-- TRAY (above controls) -->
        <div class="tray" aria-label="Image tray">
          <div class="trayTop">
            <div class="metaText">Image Tray (drag from here)</div>
            <div class="metaText" id="trayCount">0 images</div>
          </div>
          <div class="thumbGrid" id="thumbGrid"></div>
        </div>

        <!-- CONTROLS (bottom) -->
        <div class="controls" aria-label="Controls">
          <div class="box">
            <div class="metaText" style="margin-bottom:8px">Star controls</div>

            <label for="starUrl">Star Image URL (optional)</label>
            <input type="text" id="starUrl" placeholder="https://example.com/star.jpg" />

            <label for="starFile">Or upload star image</label>
            <input type="file" id="starFile" accept="image/*" />

            <label for="starTitle">Concept Core (title)</label>
            <input type="text" id="starTitle" placeholder="A short name for the star" />

            <label for="starDesc">Meaning (brief)</label>
            <textarea id="starDesc" placeholder="A short description. The grid will deepen it."></textarea>

            <div class="btnRow">
              <button id="snapshotBtn" type="button">Download Snapshot PNG</button>
              <button id="exportBtn" class="secondary" type="button">Download JSON</button>
              <label class="pill" style="cursor:pointer;border-style:dashed">
                Upload JSON
                <input id="importJson" type="file" accept="application/json" style="display:none" />
              </label>
              <button id="clearBtn" class="secondary" type="button">Clear All</button>
            </div>

            <div class="notice">
              <b>Snapshot note:</b> PNG snapshots are safest with uploaded images (embedded data).
              Some external URLs can block canvas snapshots (CORS).
            </div>
          </div>

          <div class="box">
            <div class="metaText" style="margin-bottom:8px">Bulk upload</div>
            <label for="bulkFiles">Upload many images (go to tray)</label>
            <input type="file" id="bulkFiles" accept="image/*" multiple />
            <div class="notice">
              Tip: after bulk upload, drag thumbnails from the tray into the grid or onto the Star.
              Metadata belongs to the image and travels with it.
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<!-- Image Metadata Dialog -->
<dialog id="imgDlg">
  <div class="dlgHd">
    <b id="dlgTitle">Edit Image</b>
    <button id="dlgClose" class="secondary" type="button">Close</button>
  </div>

  <div class="dlgBd">
    <div class="dlgGrid">
      <div class="previewBox">
        <div class="placeholder" id="dlgPlaceholder">No image selected.</div>
        <img id="dlgPreviewImg" alt="" style="display:none" />
      </div>

      <div>
        <label for="imgCaption">Caption (follows image)</label>
        <textarea id="imgCaption" placeholder="What does this image mean?"></textarea>

        <label for="imgTags">Tags (comma-separated)</label>
        <input type="text" id="imgTags" placeholder="tone:defiant, motif:crown, color:gold" />

        <label for="imgStrength">Strength (1 → 5)</label>
        <select id="imgStrength">
          <option value="1">1 (soft)</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5 (strong)</option>
        </select>

        <div class="btnRow">
          <button id="saveImgMeta" type="button">Save</button>
          <button id="clearImgMeta" class="secondary" type="button">Clear metadata</button>
          <button id="removeFromCell" class="secondary" type="button">Remove from this cell</button>
        </div>

        <p class="tiny" style="margin-top:10px">
          This editor updates the image object itself. Wherever you drag this image, the metadata follows.
        </p>
      </div>
    </div>
  </div>
</dialog>

<script>
  // ==========================================================
  //  Constellation Grid Model (metadata follows image)
  // ==========================================================
  const $ = (id) => document.getElementById(id);
  const SIZE = 10;
  const TOTAL = SIZE * SIZE;

  const state = {
    version: "2.0",
    created_at: new Date().toISOString(),
    imagesById: {},
    star: {
      imageId: null,
      url: "",
      data: "",
      filename: "",
      title: "",
      desc: ""
    },
    grid: Array.from({ length: TOTAL }, () => null),
    ui: {
      selectedCellIndex: -1,
      selectedImageId: null
    }
  };

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function safeName(s){
    return (s || "constellation")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      .slice(0, 60) || "constellation";
  }

  function nowStamp(){
    const d = new Date();
    const pad = (x) => String(x).padStart(2, "0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function genId(prefix="img"){
    return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function imageSrcFromId(imageId){
    if (!imageId) return "";
    const it = state.imagesById[imageId];
    return it ? (it.src || "") : "";
  }

  function starEffectiveSrc(){
    if (state.star.imageId) return imageSrcFromId(state.star.imageId);
    return state.star.data || state.star.url || "";
  }

  // ---------- rendering ----------
  function renderStar(){
    const src = starEffectiveSrc();
    const img = $("starImg");
    const ph = $("starPlaceholder");

    if (!src){
      img.style.display = "none";
      img.removeAttribute("src");
      ph.style.display = "block";
      img.alt = "";
      return;
    }
    img.src = src;
    img.alt = state.star.title ? state.star.title : "Star image";
    img.style.display = "block";
    ph.style.display = "none";
  }

  function buildGrid(){
    const gridEl = $("grid");
    gridEl.innerHTML = "";

    for (let i=0;i<TOTAL;i++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.index = String(i);

      const idx = document.createElement("div");
      idx.className = "idx";
      idx.textContent = String(i+1).padStart(2,"0");
      cell.appendChild(idx);

      const imageId = state.grid[i];
      const src = imageSrcFromId(imageId);
      if (src){
        const img = document.createElement("img");
        img.src = src;
        img.alt = (state.imagesById[imageId]?.meta?.caption) || `Cell ${i+1}`;
        img.draggable = true;
        img.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", imageId);
          e.dataTransfer.effectAllowed = "copyMove";
        });
        cell.insertBefore(img, idx);
      }

      cell.addEventListener("click", () => {
        state.ui.selectedCellIndex = i;
        const imgId = state.grid[i];
        $("metaLine").textContent = imgId
          ? `Selected: #${String(i+1).padStart(2,"0")} (Image: ${state.imagesById[imgId]?.filename || imgId})`
          : `Selected: #${String(i+1).padStart(2,"0")} (empty)`;
        if (imgId) openImageEditor(imgId);
      });

      cell.addEventListener("dragover", (e) => {
        e.preventDefault();
        cell.classList.add("dragOver");
        e.dataTransfer.dropEffect = "copy";
      });
      cell.addEventListener("dragleave", () => cell.classList.remove("dragOver"));

      // Unified drop handler: accept imageId OR file
      cell.addEventListener("drop", async (e) => {
        e.preventDefault();
        cell.classList.remove("dragOver");

        // Prefer file drops
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
          const f = e.dataTransfer.files[0];
          if (!f.type.startsWith("image/")) return;
          const id = genId();
          const src = await fileToDataURL(f);
          state.imagesById[id] = {
            id, filename: f.name || "", src,
            meta: { caption:"", tags:"", strength:3 }
          };
          state.grid[i] = id;
          renderTray();
          buildGrid();
          updateStats();
          return;
        }

        // Otherwise treat as imageId
        const imageId = e.dataTransfer.getData("text/plain");
        if (!imageId || !state.imagesById[imageId]) return;
        state.grid[i] = imageId;
        buildGrid();
        updateStats();
      });

      gridEl.appendChild(cell);
    }

    updateStats();
  }

  function renderTray(){
    const grid = $("thumbGrid");
    grid.innerHTML = "";

    const ids = Object.keys(state.imagesById);
    $("trayCount").textContent = `${ids.length} image${ids.length===1?"":"s"}`;

    for (const id of ids){
      const it = state.imagesById[id];
      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.draggable = true;
      thumb.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", id);
        e.dataTransfer.effectAllowed = "copy";
      });

      const img = document.createElement("img");
      img.src = it.src;
      img.alt = it.filename || id;
      thumb.appendChild(img);

      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = it.filename || id;
      thumb.appendChild(nm);

      thumb.addEventListener("click", () => openImageEditor(id));
      grid.appendChild(thumb);
    }
  }

  function updateStats(){
    const filled = state.grid.filter(Boolean).length;
    $("filledPill").textContent = `${filled} / ${TOTAL} filled`;

    let strengthSum = 0, count = 0;
    for (const cellId of state.grid){
      if (!cellId) continue;
      const s = Number(state.imagesById[cellId]?.meta?.strength || 3);
      strengthSum += s; count++;
    }
    const fillRatio = filled / TOTAL;
    const strengthAvg = count ? (strengthSum / count) : 0;
    const resonance = clamp(Math.round((fillRatio * 0.65 + (strengthAvg/5) * 0.35) * 100), 0, 100);

    $("resPct").textContent = `${resonance}%`;
    $("resFill").style.width = `${resonance}%`;
  }

  // ---------- star drag/drop ----------
  (function setupStarDrop(){
    const star = $("starPreview");
    star.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
      star.style.outline = "2px solid rgba(255,211,106,.65)";
      star.style.outlineOffset = "4px";
    });
    star.addEventListener("dragleave", () => {
      star.style.outline = "none";
      star.style.outlineOffset = "0";
    });

    star.addEventListener("drop", async (e) => {
      e.preventDefault();
      star.style.outline = "none";
      star.style.outlineOffset = "0";

      // Prefer file drops
      if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
        const f = e.dataTransfer.files[0];
        if (!f.type.startsWith("image/")) return;
        const id = genId();
        const src = await fileToDataURL(f);
        state.imagesById[id] = { id, filename: f.name || "", src, meta:{ caption:"", tags:"", strength:3 } };
        state.star.imageId = id;
        // clear direct fields
        state.star.url = ""; state.star.data = ""; state.star.filename = "";
        $("starUrl").value = "";
        $("starFile").value = "";
        renderTray();
        renderStar();
        return;
      }

      // Otherwise: dropped imageId
      const imageId = e.dataTransfer.getData("text/plain");
      if (imageId && state.imagesById[imageId]){
        state.star.imageId = imageId;
        state.star.url = ""; state.star.data = ""; state.star.filename = "";
        $("starUrl").value = "";
        $("starFile").value = "";
        renderStar();
      }
    });
  })();

  // ---------- star inputs ----------
  $("starUrl").addEventListener("input", (e) => {
    state.star.url = e.target.value.trim();
    state.star.imageId = null;
    state.star.data = "";
    renderStar();
  });

  $("starFile").addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    state.star.data = await fileToDataURL(f);
    state.star.filename = f.name || "";
    state.star.url = "";
    state.star.imageId = null;
    $("starUrl").value = "";
    renderStar();
  });

  $("starTitle").addEventListener("input", (e) => state.star.title = e.target.value);
  $("starDesc").addEventListener("input", (e) => state.star.desc = e.target.value);

  // ---------- bulk upload ----------
  $("bulkFiles").addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    for (const f of files){
      if (!f.type.startsWith("image/")) continue;
      const id = genId();
      const src = await fileToDataURL(f);
      state.imagesById[id] = {
        id,
        filename: f.name || "",
        src,
        meta: { caption:"", tags:"", strength:3 }
      };
    }

    renderTray();
    e.target.value = "";
  });

  // ==========================================================
  // Metadata editor
  // ==========================================================
  function openImageEditor(imageId){
    const it = state.imagesById[imageId];
    if (!it) return;
    state.ui.selectedImageId = imageId;

    $("dlgTitle").textContent = `Edit Image: ${it.filename || imageId}`;

    const img = $("dlgPreviewImg");
    const ph = $("dlgPlaceholder");
    img.src = it.src;
    img.alt = it.filename || imageId;
    img.style.display = "block";
    ph.style.display = "none";

    $("imgCaption").value = it.meta.caption || "";
    $("imgTags").value = it.meta.tags || "";
    $("imgStrength").value = String(it.meta.strength || 3);

    $("imgDlg").showModal();
  }

  $("dlgClose").addEventListener("click", () => $("imgDlg").close());

  $("saveImgMeta").addEventListener("click", () => {
    const id = state.ui.selectedImageId;
    if (!id) return;
    const it = state.imagesById[id];
    it.meta.caption = $("imgCaption").value.trim();
    it.meta.tags = $("imgTags").value.trim();
    it.meta.strength = Number($("imgStrength").value || "3");
    buildGrid();
    $("imgDlg").close();
  });

  $("clearImgMeta").addEventListener("click", () => {
    const id = state.ui.selectedImageId;
    if (!id) return;
    const it = state.imagesById[id];
    it.meta = { caption:"", tags:"", strength:3 };
    buildGrid();
    $("imgDlg").close();
  });

  $("removeFromCell").addEventListener("click", () => {
    const idx = state.ui.selectedCellIndex;
    if (idx < 0) { $("imgDlg").close(); return; }
    state.grid[idx] = null;
    buildGrid();
    $("imgDlg").close();
  });

  // ==========================================================
  // Export / Import JSON
  // ==========================================================
  function exportJSON(){
    const payload = {
      model: "ConstellationGridModel",
      version: state.version,
      exported_at: new Date().toISOString(),
      star: {
        title: state.star.title,
        desc: state.star.desc,
        imageId: state.star.imageId,
        url: state.star.url,
        data: state.star.data,
        filename: state.star.filename
      },
      images: Object.values(state.imagesById).map(it => ({
        id: it.id,
        filename: it.filename,
        src: it.src,
        meta: {
          caption: it.meta.caption || "",
          tags: it.meta.tags || "",
          strength: Number(it.meta.strength || 3)
        }
      })),
      layout: {
        rows: SIZE,
        cols: SIZE,
        grid: state.grid.slice()
      }
    };

    const name = `${safeName(state.star.title)}_${nowStamp()}.json`;
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    downloadBlob(blob, name);
  }
  $("exportBtn").addEventListener("click", exportJSON);

  $("importJson").addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      if (!obj || obj.model !== "ConstellationGridModel"){
        alert("That JSON doesn't look like a ConstellationGridModel export.");
        return;
      }

      state.imagesById = {};
      state.grid = Array.from({ length: TOTAL }, () => null);

      for (const it of (obj.images || [])){
        state.imagesById[it.id] = {
          id: it.id,
          filename: it.filename || "",
          src: it.src || "",
          meta: {
            caption: it.meta?.caption || "",
            tags: it.meta?.tags || "",
            strength: Number(it.meta?.strength || 3)
          }
        };
      }

      state.star.title = obj.star?.title || "";
      state.star.desc = obj.star?.desc || "";
      state.star.imageId = obj.star?.imageId || null;
      state.star.url = obj.star?.url || "";
      state.star.data = obj.star?.data || "";
      state.star.filename = obj.star?.filename || "";

      $("starTitle").value = state.star.title;
      $("starDesc").value = state.star.desc;
      $("starUrl").value = state.star.url || "";
      $("starFile").value = "";

      const grid = obj.layout?.grid || [];
      for (let i=0;i<TOTAL;i++){
        const id = grid[i] ?? null;
        state.grid[i] = (id && state.imagesById[id]) ? id : null;
      }

      state.ui.selectedCellIndex = -1;
      state.ui.selectedImageId = null;
      $("metaLine").textContent = "Selected: none";

      renderTray();
      renderStar();
      buildGrid();
      alert("Imported successfully ✅");
    } catch(err){
      console.error(err);
      alert("Import failed. JSON might be invalid.");
    } finally {
      e.target.value = "";
    }
  });

  // ==========================================================
  // Snapshot PNG: Star + Grid
  // ==========================================================
  async function loadToImageElement(src){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("Failed to load image (possibly CORS blocked): " + src));
      img.src = src;
    });
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawContain(ctx, img, x, y, w, h){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.min(w/iw, h/ih);
    const dw = iw*s, dh = ih*s;
    const dx = x + (w - dw)/2;
    const dy = y + (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function drawCover(ctx, img, x, y, w, h, radius){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.max(w/iw, h/ih);
    const dw = iw*s, dh = ih*s;
    const dx = x + (w - dw)/2;
    const dy = y + (h - dh)/2;

    ctx.save();
    roundRect(ctx, x, y, w, h, radius);
    ctx.clip();
    ctx.drawImage(img, dx, dy, dw, dh);
    ctx.restore();
  }

  async function drawSnapshot(){
    const starSrc = starEffectiveSrc();
    const filledCount = state.grid.filter(Boolean).length;

    if (!starSrc && filledCount === 0){
      alert("Nothing to snapshot yet. Add a star or some grid images first.");
      return null;
    }

    const pad = 24;
    const headerH = 84;

    const cell = 130;
    const gap = 14;
    const gridW = (cell * SIZE) + gap * (SIZE - 1);
    const gridH = gridW;

    const starH = 420;
    const starW = gridW;
    const canvasW = pad * 2 + gridW;
    const canvasH = pad * 2 + headerH + starH + 18 + gridH;

    const canvas = document.createElement("canvas");
    canvas.width = canvasW;
    canvas.height = canvasH;
    const ctx = canvas.getContext("2d");

    const bg = ctx.createLinearGradient(0, 0, 0, canvasH);
    bg.addColorStop(0, "#070A12");
    bg.addColorStop(1, "#0C1224");
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, canvasW, canvasH);

    function glow(x, y, r, c){
      const g = ctx.createRadialGradient(x, y, 0, x, y, r);
      g.addColorStop(0, c);
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    glow(canvasW*0.18, canvasH*0.14, 360, "rgba(124,255,203,.10)");
    glow(canvasW*0.82, canvasH*0.18, 320, "rgba(138,180,255,.12)");
    glow(canvasW*0.55, canvasH*0.92, 420, "rgba(255,106,213,.08)");

    ctx.fillStyle = "rgba(234,240,255,.95)";
    ctx.font = "900 28px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const title = state.star.title ? state.star.title : "Constellation Grid Snapshot";
    ctx.fillText(title, pad, pad + 34);

    ctx.fillStyle = "rgba(234,240,255,.70)";
    ctx.font = "600 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const meta = `Star + 10×10 • Filled: ${filledCount}/${TOTAL} • ${new Date().toLocaleString()}`;
    ctx.fillText(meta, pad, pad + 60);

    const starX = pad;
    const starY = pad + headerH;

    ctx.fillStyle = "rgba(0,0,0,.25)";
    roundRect(ctx, starX, starY, starW, starH, 22);
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 2;
    roundRect(ctx, starX, starY, starW, starH, 22);
    ctx.stroke();

    if (starSrc){
      const starImg = await loadToImageElement(starSrc);
      drawContain(ctx, starImg, starX+18, starY+18, starW-36, starH-36);
    } else {
      ctx.fillStyle = "rgba(234,240,255,.55)";
      ctx.font = "700 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("No star image", starX+22, starY+46);
    }

    const gridX = pad;
    const gridY = starY + starH + 18;

    ctx.fillStyle = "rgba(0,0,0,.18)";
    roundRect(ctx, gridX, gridY, gridW, gridH, 22);
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.lineWidth = 2;
    roundRect(ctx, gridX, gridY, gridW, gridH, 22);
    ctx.stroke();

    for (let r=0;r<SIZE;r++){
      for (let c=0;c<SIZE;c++){
        const idx = r*SIZE + c;
        const x = gridX + c*(cell+gap);
        const y = gridY + r*(cell+gap);

        ctx.fillStyle = "rgba(255,255,255,.04)";
        roundRect(ctx, x, y, cell, cell, 18);
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,.10)";
        ctx.lineWidth = 2;
        roundRect(ctx, x, y, cell, cell, 18);
        ctx.stroke();

        const imageId = state.grid[idx];
        const src = imageSrcFromId(imageId);
        if (src){
          try{
            const im = await loadToImageElement(src);
            drawCover(ctx, im, x, y, cell, cell, 18);
          } catch (e){
            ctx.fillStyle = "rgba(255,106,213,.14)";
            roundRect(ctx, x, y, cell, cell, 18);
            ctx.fill();
            ctx.fillStyle = "rgba(234,240,255,.75)";
            ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
            ctx.fillText("blocked", x+14, y+28);
          }
        }

        ctx.fillStyle = "rgba(0,0,0,.55)";
        roundRect(ctx, x + cell - 42, y + cell - 28, 34, 20, 10);
        ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,.15)";
        ctx.lineWidth = 1;
        roundRect(ctx, x + cell - 42, y + cell - 28, 34, 20, 10);
        ctx.stroke();

        ctx.fillStyle = "rgba(234,240,255,.92)";
        ctx.font = "800 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        ctx.fillText(String(idx+1).padStart(2,"0"), x + cell - 36, y + cell - 14);
      }
    }

    return canvas;
  }

  async function downloadSnapshotPNG(){
    try{
      const canvas = await drawSnapshot();
      if (!canvas) return;
      const name = `${safeName(state.star.title)}_${nowStamp()}.png`;
      canvas.toBlob((blob) => {
        if (!blob){
          alert("Snapshot failed (canvas export blocked). Try using uploaded images instead of external URLs.");
          return;
        }
        downloadBlob(blob, name);
      }, "image/png");
    } catch (err){
      console.error(err);
      alert(
        "Snapshot failed. Most common cause: an external image URL that blocks canvas use (CORS).\n\n" +
        "Fix: upload images (embedded data) or use URLs from a server that allows cross-origin image usage."
      );
    }
  }
  $("snapshotBtn").addEventListener("click", downloadSnapshotPNG);

  // ---------- clear ----------
  $("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear star + grid + tray?")) return;

    state.imagesById = {};
    state.grid = Array.from({ length: TOTAL }, () => null);
    state.star = { imageId:null, url:"", data:"", filename:"", title:"", desc:"" };
    state.ui.selectedCellIndex = -1;
    state.ui.selectedImageId = null;

    $("starUrl").value = "";
    $("starFile").value = "";
    $("starTitle").value = "";
    $("starDesc").value = "";
    $("metaLine").textContent = "Selected: none";

    renderTray();
    renderStar();
    buildGrid();
  });

  // Init
  renderTray();
  renderStar();
  buildGrid();
  updateStats();
</script>
</body>
</html>
