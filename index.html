<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Constellation Grid: Star + 10×10 + Snapshot + JSON</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0C1224;
      --panel: rgba(15,26,51,.72);
      --panel2: rgba(0,0,0,.18);
      --ink:#EAF0FF;
      --muted:#B9C2E3;
      --line: rgba(255,255,255,.12);

      --a:#7CFFCB;
      --b:#8AB4FF;
      --c:#FF6AD5;
      --d:#FFD36A;
      --e:#B388FF;

      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;

      --cell: 68px;
      --gap: 10px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,255,203,.15), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(138,180,255,.18), transparent 55%),
        radial-gradient(900px 700px at 45% 100%, rgba(255,106,213,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 18px 10px;
      display:flex; gap:12px; align-items:flex-start;
    }
    .sigil{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 220deg, var(--a), var(--b), var(--c), var(--d), var(--e), var(--a));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .sigil:before{
      content:"";
      position:absolute; inset:2px;
      border-radius:12px;
      background: radial-gradient(16px 16px at 30% 25%, rgba(255,255,255,.55), transparent 60%),
                  radial-gradient(22px 22px at 70% 70%, rgba(0,0,0,.35), transparent 60%),
                  rgba(10,16,34,.65);
      border: 1px solid rgba(255,255,255,.14);
    }
    h1{ margin:0; font-size: clamp(1.15rem, 2.2vw, 1.65rem); letter-spacing:.2px; }
    .sub{ margin:7px 0 0; color:var(--muted); line-height:1.45; max-width: 92ch; font-size: .96rem; }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px 40px;
    }

    .card{
      background: linear-gradient(180deg, rgba(15,26,51,.82), rgba(15,26,51,.55));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(90deg, rgba(124,255,203,.08), rgba(138,180,255,.06), rgba(255,106,213,.06));
      flex-wrap:wrap;
    }
    .bd{ padding: 14px; }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }

    /* --- Star sits ON TOP, grid immediately beneath --- */
    .starArea{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:stretch;
      margin-bottom: 12px;
    }
    @media (max-width: 860px){
      .starArea{ grid-template-columns: 1fr; }
    }

    .starPreview{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(260px 130px at 25% 20%, rgba(255,211,106,.12), transparent 65%),
        radial-gradient(320px 150px at 80% 55%, rgba(179,136,255,.12), transparent 65%),
        rgba(0,0,0,.18);
      position:relative;
      min-height: 300px;
      display:flex; align-items:center; justify-content:center;
      padding: 14px;
      overflow:hidden;
    }
    .starPreview img{
      max-width:100%;
      max-height: 420px;
      object-fit:contain;
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .placeholder{
      text-align:center;
      color: var(--muted);
      line-height:1.4;
      max-width: 60ch;
    }
    .sparkline{
      position:absolute; inset:auto 12px 12px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      font-size:.78rem;
      color: rgba(234,240,255,.82);
    }
    .sparkbar{
      flex:1;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .sparkbar > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
    }

    .controls label{
      display:block;
      color: var(--muted);
      font-size: .85rem;
      margin: 10px 0 6px;
    }
    input[type="text"], textarea, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input[type="file"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(90deg, rgba(124,255,203,.16), rgba(138,180,255,.14), rgba(255,106,213,.14));
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 750;
      letter-spacing:.2px;
    }
    button.secondary{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-weight: 650;
    }
    button:active{ transform: translateY(1px); }

    /* Grid directly below star */
    .gridBlock{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      padding: 12px;
    }

    .gridMetaLine{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .metaText{
      color: var(--muted);
      font-size: .9rem;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(10, var(--cell));
      gap: var(--gap);
      padding: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 20% 0%, rgba(124,255,203,.10), transparent 60%),
        radial-gradient(620px 360px at 90% 30%, rgba(255,106,213,.09), transparent 60%),
        rgba(0,0,0,.16);
      overflow:auto;
      max-width: 100%;
    }
    .cell{
      width: var(--cell);
      height: var(--cell);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      user-select:none;
    }
    .cell:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .cell img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.03) contrast(1.03);
    }
    .cell .idx{
      position:absolute;
      right:6px; bottom:6px;
      font-size: .70rem;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,.50);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(234,240,255,.92);
      pointer-events:none;
    }
    .cell .dot{
      position:absolute;
      left:8px; top:8px;
      width:10px; height:10px; border-radius: 999px;
      background: rgba(255,255,255,.20);
      border: 1px solid rgba(255,255,255,.18);
      pointer-events:none;
    }
    .cell[data-intensity="1"] .dot{ background: rgba(124,255,203,.55); }
    .cell[data-intensity="2"] .dot{ background: rgba(138,180,255,.55); }
    .cell[data-intensity="3"] .dot{ background: rgba(255,106,213,.55); }
    .cell[data-intensity="4"] .dot{ background: rgba(255,211,106,.60); }
    .cell[data-intensity="5"] .dot{ background: rgba(179,136,255,.60); }

    /* Editor (simple modal) */
    dialog{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(10,16,34,.96);
      color: var(--ink);
      box-shadow: var(--shadow);
      width: min(720px, calc(100% - 24px));
    }
    dialog::backdrop{
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .dlgHd{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(255,211,106,.08), rgba(179,136,255,.08), rgba(138,180,255,.06));
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }
    .dlgHd b{ letter-spacing:.2px; }
    .dlgBd{ padding: 12px; }
    .dlgGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .dlgGrid{ grid-template-columns: 1fr; }
    }
    .previewBox{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      min-height: 240px;
      display:flex; align-items:center; justify-content:center;
      padding: 12px;
      overflow:hidden;
    }
    .previewBox img{
      max-width:100%;
      max-height: 380px;
      object-fit:contain;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .tiny{
      color: rgba(234,240,255,.72);
      font-size: .82rem;
      line-height:1.35;
    }

    .notice{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(234,240,255,.78);
      font-size: .86rem;
      line-height:1.35;
    }
    .notice b{ color: var(--d); }
  </style>
</head>

<body>
<header>
  <div class="sigil" aria-hidden="true"></div>
  <div>
    <h1>Constellation Grid</h1>
    <p class="sub">
      Star on top. Grid immediately beneath. Export/Import JSON for plug-and-play recreation.
      Create a real <b>snapshot image</b> (PNG) of the star + full 10×10 grid.
    </p>
  </div>
</header>

<main>
  <section class="card" aria-label="Star and grid">
    <div class="hd">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span class="pill">⭐ Star + 10×10</span>
        <span class="pill" style="border-color:rgba(124,255,203,.28)">Snapshot PNG</span>
        <span class="pill" style="border-color:rgba(255,106,213,.26)">Export / Import JSON</span>
      </div>
      <span class="pill" id="filledPill">0 / 100 filled</span>
    </div>

    <div class="bd">
      <!-- STAR ON TOP -->
      <div class="starArea" id="captureRoot">
        <div class="starPreview" id="starPreview" aria-label="Star preview">
          <div class="placeholder" id="starPlaceholder">
            <div style="font-weight:900;font-size:1.05rem;margin-bottom:6px">Put your Star here</div>
            <div>Use a URL or upload a file. This is the “energy source” the grid will echo.</div>
          </div>
          <img id="starImg" alt="" style="display:none" />
          <div class="sparkline">
            <span>Grid Resonance</span>
            <div class="sparkbar" aria-hidden="true"><i id="resFill"></i></div>
            <span id="resPct">0%</span>
          </div>
        </div>

        <div class="controls" aria-label="Star controls">
          <label for="starUrl">Star Image URL</label>
          <input type="text" id="starUrl" placeholder="https://example.com/star.jpg" />

          <label for="starFile">Or upload star image</label>
          <input type="file" id="starFile" accept="image/*" />

          <label for="starTitle">Concept Core (title)</label>
          <input type="text" id="starTitle" placeholder="A short name for the star" />

          <label for="starDesc">Meaning (brief)</label>
          <textarea id="starDesc" placeholder="A short description. The grid will deepen it."></textarea>

          <div class="btnRow">
            <button id="snapshotBtn" type="button">Download Snapshot PNG</button>
            <button id="exportBtn" class="secondary" type="button">Download JSON</button>
            <label class="pill" style="cursor:pointer;border-style:dashed">
              Upload JSON
              <input id="importJson" type="file" accept="application/json" style="display:none" />
            </label>
            <button id="clearBtn" class="secondary" type="button">Clear All</button>
          </div>

          <div class="notice">
            <b>Snapshot note:</b> PNG snapshots require that images be usable in canvas.
            Uploading images (stored as data) is safest. Some external URLs may block snapshots if they don’t allow cross-origin use.
          </div>
        </div>
      </div>

      <!-- GRID IMMEDIATELY UNDER STAR -->
      <div class="gridBlock" aria-label="Grid block">
        <div class="gridMetaLine">
          <div class="metaText">Click a cell to edit. (Drag & drop can be added later.)</div>
          <div class="metaText" id="metaLine">Selected: none</div>
        </div>
        <div class="grid" id="grid" aria-label="10 by 10 grid"></div>
      </div>
    </div>
  </section>
</main>

<!-- Cell Editor Dialog -->
<dialog id="cellDlg">
  <div class="dlgHd">
    <b id="dlgTitle">Edit Cell</b>
    <button id="dlgClose" class="secondary" type="button">Close</button>
  </div>

  <div class="dlgBd">
    <div class="dlgGrid">
      <div class="previewBox">
        <div class="placeholder" id="cellPlaceholder">No image yet. Add a URL or upload a file.</div>
        <img id="cellPreviewImg" alt="" style="display:none" />
      </div>

      <div>
        <label for="cellUrl">Image URL</label>
        <input type="text" id="cellUrl" placeholder="https://example.com/echo.jpg" />

        <label for="cellFile">Or upload image (recommended for snapshots)</label>
        <input type="file" id="cellFile" accept="image/*" />

        <label for="cellText">Caption (short)</label>
        <textarea id="cellText" placeholder="What aspect of the star does this echo?"></textarea>

        <label for="cellTags">Tags (comma-separated)</label>
        <input type="text" id="cellTags" placeholder="tone:defiant, motif:crown, color:gold" />

        <label for="cellIntensity">Intensity (1 → 5)</label>
        <select id="cellIntensity">
          <option value="1">1 (soft)</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
          <option value="5">5 (strong)</option>
        </select>

        <div class="btnRow">
          <button id="saveCell" type="button">Save Cell</button>
          <button id="clearCell" class="secondary" type="button">Clear Cell</button>
        </div>

        <p class="tiny" style="margin-top:10px">
          JSON export stores: URLs, captions, tags, intensity, and (for uploads) embedded image data + original filename.
          Import restores everything.
        </p>
      </div>
    </div>
  </div>
</dialog>

<script>
  // =============================
  // State + Utilities
  // =============================
  const $ = (id) => document.getElementById(id);
  const SIZE = 10;
  const TOTAL = SIZE * SIZE;

  const state = {
    version: "1.1",
    created_at: new Date().toISOString(),
    star: {
      // url: external URL if provided
      url: "",
      // data: dataURL if uploaded (best for snapshot + portability)
      data: "",
      // filename: original local filename if uploaded
      filename: "",
      title: "",
      desc: ""
    },
    cells: Array.from({ length: TOTAL }, () => ({
      url: "",
      data: "",
      filename: "",
      caption: "",
      tags: "",
      intensity: 3
    })),
    selected: -1
  };

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function safeName(s){
    return (s || "constellation")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      .slice(0, 60) || "constellation";
  }

  function nowStamp(){
    const d = new Date();
    const pad = (x) => String(x).padStart(2, "0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  // Prefer embedded data, fallback to URL
  function getImageSrc(obj){
    return obj.data || obj.url || "";
  }

  // Convert File -> dataURL
  function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // =============================
  // Render: Star + Grid
  // =============================
  function renderStar(){
    const src = getImageSrc(state.star);
    const img = $("starImg");
    const ph = $("starPlaceholder");

    if (!src){
      img.style.display = "none";
      img.removeAttribute("src");
      ph.style.display = "block";
      img.alt = "";
      return;
    }

    img.src = src;
    img.alt = state.star.title ? state.star.title : "Star image";
    img.style.display = "block";
    ph.style.display = "none";
  }

  function buildGrid(){
    const grid = $("grid");
    grid.innerHTML = "";

    for (let i = 0; i < TOTAL; i++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.index = String(i);
      cell.dataset.intensity = String(state.cells[i].intensity || 3);

      const dot = document.createElement("div");
      dot.className = "dot";
      cell.appendChild(dot);

      const idx = document.createElement("div");
      idx.className = "idx";
      idx.textContent = String(i+1).padStart(2, "0");
      cell.appendChild(idx);

      const src = getImageSrc(state.cells[i]);
      if (src){
        const img = document.createElement("img");
        img.src = src;
        img.alt = state.cells[i].caption ? state.cells[i].caption : `Cell ${i+1}`;
        cell.insertBefore(img, dot);
      }

      cell.addEventListener("click", () => openCellEditor(i));
      grid.appendChild(cell);
    }

    updateStats();
  }

  function updateStats(){
    const filled = state.cells.filter(c => !!getImageSrc(c)).length;
    $("filledPill").textContent = `${filled} / ${TOTAL} filled`;

    // Illustrative resonance metric: fill ratio + intensity avg among filled
    let intensitySum = 0, count = 0;
    for (const c of state.cells){
      if (!getImageSrc(c)) continue;
      intensitySum += Number(c.intensity || 3);
      count++;
    }
    const fillRatio = filled / TOTAL;
    const intensityAvg = count ? (intensitySum / count) : 0;
    const resonance = clamp(Math.round((fillRatio * 0.65 + (intensityAvg/5) * 0.35) * 100), 0, 100);

    $("resPct").textContent = `${resonance}%`;
    $("resFill").style.width = `${resonance}%`;
  }

  // =============================
  // Star Inputs
  // =============================
  $("starUrl").addEventListener("input", (e) => {
    state.star.url = e.target.value.trim();
    // If user sets URL, we keep embedded data if already present, but preview prefers data first.
    // If you want URL to override, clear star.data here. We'll keep data as king for snapshots.
    renderStar();
  });

  $("starFile").addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    state.star.data = await fileToDataURL(f);
    state.star.filename = f.name || "";
    // keep URL field but clear its input to avoid confusion
    $("starUrl").value = "";
    state.star.url = "";
    renderStar();
  });

  $("starTitle").addEventListener("input", (e) => state.star.title = e.target.value);
  $("starDesc").addEventListener("input", (e) => state.star.desc = e.target.value);

  // =============================
  // Cell Editor
  // =============================
  function openCellEditor(i){
    state.selected = i;
    $("metaLine").textContent = `Selected: #${String(i+1).padStart(2,"0")} (row ${Math.floor(i/SIZE)+1}, col ${(i%SIZE)+1})`;

    const c = state.cells[i];
    $("dlgTitle").textContent = `Edit Cell #${String(i+1).padStart(2,"0")}`;
    $("cellUrl").value = c.url || "";
    $("cellText").value = c.caption || "";
    $("cellTags").value = c.tags || "";
    $("cellIntensity").value = String(c.intensity || 3);
    $("cellFile").value = "";

    renderCellPreview(c);

    $("cellDlg").showModal();
  }

  function renderCellPreview(c){
    const src = getImageSrc(c);
    const img = $("cellPreviewImg");
    const ph = $("cellPlaceholder");
    if (!src){
      img.style.display = "none";
      img.removeAttribute("src");
      ph.style.display = "block";
      return;
    }
    img.src = src;
    img.alt = c.caption || "Cell image";
    img.style.display = "block";
    ph.style.display = "none";
  }

  $("dlgClose").addEventListener("click", () => $("cellDlg").close());

  $("cellUrl").addEventListener("input", () => {
    const i = state.selected;
    if (i < 0) return;
    state.cells[i].url = $("cellUrl").value.trim();
    // keep embedded data as preferred; do not auto-clear.
    renderCellPreview(state.cells[i]);
  });

  $("cellFile").addEventListener("change", async (e) => {
    const i = state.selected;
    if (i < 0) return;
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    state.cells[i].data = await fileToDataURL(f);
    state.cells[i].filename = f.name || "";
    // When uploading, clear URL for portability + snapshot reliability
    state.cells[i].url = "";
    $("cellUrl").value = "";
    renderCellPreview(state.cells[i]);
  });

  $("saveCell").addEventListener("click", () => {
    const i = state.selected;
    if (i < 0) return;

    state.cells[i].caption = $("cellText").value.trim();
    state.cells[i].tags = $("cellTags").value.trim();
    state.cells[i].intensity = Number($("cellIntensity").value || "3");

    buildGrid();
    $("cellDlg").close();
  });

  $("clearCell").addEventListener("click", () => {
    const i = state.selected;
    if (i < 0) return;
    state.cells[i] = { url:"", data:"", filename:"", caption:"", tags:"", intensity:3 };
    buildGrid();
    $("cellDlg").close();
  });

  // =============================
  // Export / Import JSON (Plug & Play)
  // =============================
  function exportJSON(){
    const payload = {
      model: "ConstellationGridModel",
      version: state.version,
      exported_at: new Date().toISOString(),
      star: {
        title: state.star.title,
        desc: state.star.desc,
        url: state.star.url,
        data: state.star.data,
        filename: state.star.filename
      },
      grid: {
        rows: SIZE,
        cols: SIZE,
        cells: state.cells.map((c, idx) => ({
          index: idx + 1,
          row: Math.floor(idx / SIZE) + 1,
          col: (idx % SIZE) + 1,
          image_url: c.url,
          image_data: c.data,
          filename: c.filename,
          caption: c.caption,
          tags: c.tags,
          intensity: Number(c.intensity || 3)
        }))
      }
    };

    const name = `${safeName(state.star.title)}_${nowStamp()}.json`;
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    downloadBlob(blob, name);
  }

  $("exportBtn").addEventListener("click", exportJSON);

  $("importJson").addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    try{
      const text = await f.text();
      const obj = JSON.parse(text);

      if (!obj || obj.model !== "ConstellationGridModel") {
        alert("That JSON doesn't look like a ConstellationGridModel export.");
        return;
      }

      // Restore star
      state.star.title = obj.star?.title || "";
      state.star.desc = obj.star?.desc || "";
      state.star.url = obj.star?.url || "";
      state.star.data = obj.star?.data || "";
      state.star.filename = obj.star?.filename || "";

      $("starTitle").value = state.star.title;
      $("starDesc").value = state.star.desc;

      // Keep starUrl input in sync only if URL is used
      $("starUrl").value = state.star.url || "";
      $("starFile").value = "";

      // Restore cells
      const cells = obj.grid?.cells || [];
      state.cells = Array.from({ length: TOTAL }, (_, idx) => {
        const c = cells[idx] || {};
        return {
          url: c.image_url || "",
          data: c.image_data || "",
          filename: c.filename || "",
          caption: c.caption || "",
          tags: c.tags || "",
          intensity: Number(c.intensity || 3)
        };
      });

      state.selected = -1;
      $("metaLine").textContent = "Selected: none";

      renderStar();
      buildGrid();
      alert("Imported successfully ✅");
    } catch(err){
      console.error(err);
      alert("Import failed. JSON might be invalid.");
    } finally {
      e.target.value = "";
    }
  });

  // =============================
  // Snapshot PNG: Star + Grid (true image file)
  // =============================
  async function loadToImageElement(src){
    // Create an <img> that is safe for canvas if possible.
    // For data URLs: always OK.
    // For remote URLs: may fail due to CORS, in which case snapshot might fail.
    return new Promise((resolve, reject) => {
      const img = new Image();
      // Try to request CORS-friendly if server allows it
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("Failed to load image (possibly CORS blocked): " + src));
      img.src = src;
    });
  }

  async function drawSnapshot(){
    const starSrc = getImageSrc(state.star);
    const filledCount = state.cells.filter(c => !!getImageSrc(c)).length;

    if (!starSrc && filledCount === 0){
      alert("Nothing to snapshot yet. Add a star or some grid images first.");
      return;
    }

    // Canvas layout
    const pad = 24;
    const headerH = 84;

    const cell = 130;          // snapshot cell size (bigger than UI for nice export)
    const gap = 14;
    const gridW = (cell * SIZE) + gap * (SIZE - 1);
    const gridH = gridW;

    const starH = 420;
    const starW = gridW;       // make star as wide as grid, centered
    const canvasW = pad * 2 + gridW;
    const canvasH = pad * 2 + headerH + starH + 18 + gridH;

    const canvas = document.createElement("canvas");
    canvas.width = canvasW;
    canvas.height = canvasH;
    const ctx = canvas.getContext("2d");

    // Background
    const bg = ctx.createLinearGradient(0, 0, 0, canvasH);
    bg.addColorStop(0, "#070A12");
    bg.addColorStop(1, "#0C1224");
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, canvasW, canvasH);

    // Soft glows
    function glow(x, y, r, c){
      const g = ctx.createRadialGradient(x, y, 0, x, y, r);
      g.addColorStop(0, c);
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    glow(canvasW*0.18, canvasH*0.14, 360, "rgba(124,255,203,.10)");
    glow(canvasW*0.82, canvasH*0.18, 320, "rgba(138,180,255,.12)");
    glow(canvasW*0.55, canvasH*0.92, 420, "rgba(255,106,213,.08)");

    // Header text
    ctx.fillStyle = "rgba(234,240,255,.95)";
    ctx.font = "900 28px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const title = state.star.title ? state.star.title : "Constellation Grid Snapshot";
    ctx.fillText(title, pad, pad + 34);

    ctx.fillStyle = "rgba(234,240,255,.70)";
    ctx.font = "600 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const meta = `Star + 10×10 • Filled: ${filledCount}/${TOTAL} • ${new Date().toLocaleString()}`;
    ctx.fillText(meta, pad, pad + 60);

    // Draw star frame
    const starX = pad;
    const starY = pad + headerH;

    ctx.fillStyle = "rgba(0,0,0,.25)";
    roundRect(ctx, starX, starY, starW, starH, 22);
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 2;
    roundRect(ctx, starX, starY, starW, starH, 22);
    ctx.stroke();

    // Draw star image (contain)
    if (starSrc){
      const starImg = await loadToImageElement(starSrc);
      drawContain(ctx, starImg, starX+18, starY+18, starW-36, starH-36);
    } else {
      // placeholder text
      ctx.fillStyle = "rgba(234,240,255,.55)";
      ctx.font = "700 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("No star image", starX+22, starY+46);
    }

    // Draw grid
    const gridX = pad;
    const gridY = starY + starH + 18;

    ctx.fillStyle = "rgba(0,0,0,.18)";
    roundRect(ctx, gridX, gridY, gridW, gridH, 22);
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.lineWidth = 2;
    roundRect(ctx, gridX, gridY, gridW, gridH, 22);
    ctx.stroke();

    // Draw each cell
    for (let r = 0; r < SIZE; r++){
      for (let c = 0; c < SIZE; c++){
        const idx = r*SIZE + c;
        const x = gridX + c*(cell+gap);
        const y = gridY + r*(cell+gap);

        // cell background
        ctx.fillStyle = "rgba(255,255,255,.04)";
        roundRect(ctx, x, y, cell, cell, 18);
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,.10)";
        ctx.lineWidth = 2;
        roundRect(ctx, x, y, cell, cell, 18);
        ctx.stroke();

        // image
        const src = getImageSrc(state.cells[idx]);
        if (src){
          try{
            const im = await loadToImageElement(src);
            drawCover(ctx, im, x, y, cell, cell, 18);
          } catch (e){
            // If CORS blocks one image, we still render the rest.
            ctx.fillStyle = "rgba(255,106,213,.14)";
            roundRect(ctx, x, y, cell, cell, 18);
            ctx.fill();
            ctx.fillStyle = "rgba(234,240,255,.75)";
            ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
            ctx.fillText("blocked", x+14, y+28);
          }
        }

        // small index badge
        ctx.fillStyle = "rgba(0,0,0,.55)";
        roundRect(ctx, x + cell - 42, y + cell - 28, 34, 20, 10);
        ctx.fill();
        ctx.strokeStyle = "rgba(255,255,255,.15)";
        ctx.lineWidth = 1;
        roundRect(ctx, x + cell - 42, y + cell - 28, 34, 20, 10);
        ctx.stroke();

        ctx.fillStyle = "rgba(234,240,255,.92)";
        ctx.font = "800 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        ctx.fillText(String(idx+1).padStart(2,"0"), x + cell - 36, y + cell - 14);
      }
    }

    return canvas;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawContain(ctx, img, x, y, w, h){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.min(w/iw, h/ih);
    const dw = iw*s, dh = ih*s;
    const dx = x + (w - dw)/2;
    const dy = y + (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function drawCover(ctx, img, x, y, w, h, radius){
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    const s = Math.max(w/iw, h/ih);
    const dw = iw*s, dh = ih*s;
    const dx = x + (w - dw)/2;
    const dy = y + (h - dh)/2;

    // clip rounded
    ctx.save();
    roundRect(ctx, x, y, w, h, radius);
    ctx.clip();
    ctx.drawImage(img, dx, dy, dw, dh);
    ctx.restore();
  }

  async function downloadSnapshotPNG(){
    try{
      const canvas = await drawSnapshot();
      const name = `${safeName(state.star.title)}_${nowStamp()}.png`;
      canvas.toBlob((blob) => {
        if (!blob){
          alert("Snapshot failed (canvas export blocked). Try using uploaded images instead of external URLs.");
          return;
        }
        downloadBlob(blob, name);
      }, "image/png");
    } catch (err){
      console.error(err);
      alert(
        "Snapshot failed. Most common cause: an external image URL that blocks canvas use (CORS).\n\n" +
        "Fix: upload images (embedded data) or use URLs from a server that allows cross-origin image usage."
      );
    }
  }

  $("snapshotBtn").addEventListener("click", downloadSnapshotPNG);

  // =============================
  // Clear All
  // =============================
  $("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear star + all 100 cells?")) return;

    state.star = { url:"", data:"", filename:"", title:"", desc:"" };
    state.cells = Array.from({ length: TOTAL }, () => ({
      url:"", data:"", filename:"", caption:"", tags:"", intensity:3
    }));
    state.selected = -1;

    $("starUrl").value = "";
    $("starFile").value = "";
    $("starTitle").value = "";
    $("starDesc").value = "";
    $("metaLine").textContent = "Selected: none";

    renderStar();
    buildGrid();
  });

  // =============================
  // Init
  // =============================
  renderStar();
  buildGrid();
</script>
</body>
</html>
